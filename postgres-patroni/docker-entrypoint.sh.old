#!/bin/bash
set -e

export PATRONI_SCOPE="${PATRONI_SCOPE:-railway-pg-ha}"
export PATRONI_NAME="${PATRONI_NAME:-postgres-1}"
export PATRONI_ETCD_HOSTS="${PATRONI_ETCD_HOSTS:-etcd-1.railway.internal:2379,etcd-2.railway.internal:2379,etcd-3.railway.internal:2379}"

export PATRONI_SUPERUSER_USERNAME="${POSTGRES_USER:-postgres}"
export PATRONI_SUPERUSER_PASSWORD="${POSTGRES_PASSWORD:-postgres}"
export PATRONI_REPLICATION_USERNAME="${PATRONI_REPLICATION_USERNAME:-replicator}"
export PATRONI_REPLICATION_PASSWORD="${PATRONI_REPLICATION_PASSWORD:-replicator_password}"

export POSTGRESQL_DATA_DIR="${PGDATA:-/var/lib/postgresql/data/pgdata}"
export PATRONI_TTL="${PATRONI_TTL:-30}"
export PATRONI_LOOP_WAIT="${PATRONI_LOOP_WAIT:-10}"

# Don't use config file - use environment variables only
unset PATRONI_CONFIG_FILE

# Railway volumes are already mounted with correct permissions
# Don't try to chmod/chown the volume mount point

echo "Starting Patroni with:"
echo "  Scope: ${PATRONI_SCOPE}"
echo "  Name: ${PATRONI_NAME}"
echo "  etcd: ${PATRONI_ETCD_HOSTS}"
echo "  Data dir: ${POSTGRESQL_DATA_DIR}"

# Substitute environment variables in patroni.yml template
# Explicitly list all variables to substitute to avoid issues with undefined vars
envsubst '$PATRONI_SCOPE $PATRONI_NAME $PATRONI_ETCD_HOSTS $PATRONI_SUPERUSER_USERNAME $PATRONI_SUPERUSER_PASSWORD $PATRONI_REPLICATION_USERNAME $PATRONI_REPLICATION_PASSWORD $POSTGRESQL_DATA_DIR $PATRONI_TTL $PATRONI_LOOP_WAIT' < /etc/patroni/patroni.yml > /tmp/patroni.yml

echo "Generated Patroni config - postgresql section:"
grep -A 10 "^postgresql:" /tmp/patroni.yml || echo "ERROR: postgresql section not found!"
echo ""
echo "Full config file:"
cat /tmp/patroni.yml

# Use the processed config file
export PATRONI_CONFIG_FILE=/tmp/patroni.yml

exec "$@"
